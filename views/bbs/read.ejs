<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html"; charset="utf-8"/>
    <title>글읽기</title>
    <style>
        /* 기본 스타일 */
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; margin-bottom: 20px; }
        td, th { border: 1px solid #ccc; padding: 8px; }
        a { text-decoration: none; color: #007bff; }
        a:hover { text-decoration: underline; }
        button { padding: 5px 10px; cursor: pointer; border: 1px solid #ccc; background-color: #f0f0f0; }
        button:hover { background-color: #e0e0e0; }
        .like-button, .dislike-button {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            margin-right: 5px;
        }
        .like-button.active {
            background-color: #28a745; /* 좋아요 선택 시 초록색 */
            color: white;
            border-color: #28a745;
        }
        .dislike-button.active {
            background-color: #dc3545; /* 싫어요 선택 시 빨간색 */
            color: white;
            border-color: #dc3545;
        }

        /* 댓글 들여쓰기 스타일 */
        .comment-item {
            border-bottom: 1px dashed #eee;
            padding: 10px 0;
            margin-bottom: 5px; /* 각 댓글 항목 간 간격 */
        }
        .comment-content {
            margin-bottom: 5px;
        }
        /* DEPTH에 따른 들여쓰기 클래스 */
        .depth-0 { padding-left: 0px; }
        .depth-1 { padding-left: 30px; background-color: #f9f9f9; }
        .depth-2 { padding-left: 60px; background-color: #f0f0f0; }
        .depth-3 { padding-left: 90px; background-color: #e6e6e6; }
        .depth-4 { padding-left: 120px; background-color: #dcdcdc; }
        /* 필요에 따라 더 깊은 depth 추가 및 스타일 조정 */

        /* 답글 입력 폼 숨김 처리 */
        .reply-form {
            display: none; /* 기본적으로 숨김 */
            margin-top: 10px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fafafa;
        }
        .deleted-comment {
            color: #999;
            font-style: italic;
            background-color: #f2f2f2;
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <%
        console.log("bbs.rows : " + JSON.stringify(bbs.rows)); // 백엔드에서 받은 게시글 데이터
        var column = bbs.rows[0]; // 게시글 정보 배열
    %>
    <h2>게시글 보기</h2>
    <table border="1" style="width:1024px">
        <tbody>
            <tr><td>글번호</td><td><%=column[0]%></td></tr>
            <tr><td>작성자</td><td><%=column[3]%></td></tr>
            <tr><td>제목</td><td><%=column[1]%></td></tr>
            <tr><td>내용</td><td><%=column[2]%></td></tr>
            <tr><td>작성 날짜</td><td><%=column[4]%></td></tr>
            <tr><td>조회수</td><td><%=column[6]%></td></tr>
            <tr>
                <td>첨부 파일</td>
                <td>
                    <% if (column[7] && column[8]) { %>
                        <a href="<%= column[7] %>" download="<%= column[8] %>">
                            <%= column[8] %>
                        </a>
                    <% } else { %>
                        첨부 파일 없음
                    <% } %>
                </td>
            </tr>
        </tbody>
    </table>
    <p>
        <a href="/bbs/list">게시판 홈으로 돌아가기</a> /
        <a href="/bbs/delete?brdno=<%=column[0]%>">게시글 삭제</a> /
        <a href="/bbs/update?brdno=<%=column[0]%>">게시글 수정</a>
    </p>

    <hr/>

    <h3>새 댓글 작성</h3>
    <form name="commentForm" action="/bbs/wsave" method="post">
        <table border="1" style="width:1024px">
            <tbody>
                <tr>
                    <td>댓글 내용</td>
                    <td><textarea name="wbrdmemo" rows="3" cols="70" placeholder="댓글을 입력하세요."></textarea></td>
                </tr>          
            </tbody>
        </table>
        <button type="submit">댓글 저장</button>
        <input type="hidden" name="bbsno" value="<%=column[0]%>">
        <input type="hidden" name="parent_no" value=""> </form>

    <hr/>

    <h3>댓글 목록 (<%= wbbs.length %>개)</h3>
    <div id="comments-container">
        <%
            console.log("wbbs.length : " + wbbs.length); // 백엔드에서 받은 댓글 데이터 배열의 길이
            for(var i = 0; i < wbbs.length; i++) { 
                var wcolumn = wbbs[i]; // 배열의 요소 직접 접근
                // 백엔드 read 라우터에서 조회하는 컬럼 순서에 따라 인덱스 조정
                // [0]: NO, [1]: BBS_NO, [2]: WRITER, [3]: CONTENT
                // [4]: REGDATE_FORMATTED, [5]: WCOUNT, [6]: OK
                // [7]: PARENT_NO, [8]: DEPTH, [9]: GROUP_ID, [10]: ORDER_IN_GROUP
                // [11]: GOOD, [12]: BAD
                // [13]: MY_VOTE_TYPE (추가됨)

                var commentNo = wcolumn[0];
                var writer = wcolumn[2];
                var content = wcolumn[3];
                var regDate = wcolumn[4];
                var depth = wcolumn[8]; // DEPTH 값 사용
                var okStatus = wcolumn[6]; // OK 값 (0 또는 1)
                var goodCount = wcolumn[11]; // GOOD (좋아요 수)
                var badCount = wcolumn[12];  // BAD (싫어요 수)
                var myVoteType = wcolumn[13]; // MY_VOTE_TYPE (로그인한 사용자의 투표 여부)
        %>
            <div class="comment-item depth-<%= depth %>">
                <% if (okStatus === 0) { %>
                    <div class="deleted-comment">
                        삭제된 댓글입니다.
                        <% // 삭제된 댓글에는 답글 달기 버튼을 표시하지 않습니다. %>
                    </div>
                <% } else { %>
                    <div class="comment-header">
                        <strong><%= writer %></strong> <span style="font-size: 0.8em; color: #888;">(<%= regDate %>)</span>
                    </div>
                    <div class="comment-content">
                        <%= content %>
                    </div>
                    <div class="comment-actions">
                        <% if (loggedInUser) { // 로그인한 사용자에게만 좋아요/싫어요 버튼 표시 %>
                            <button type="button" class="like-button <%= myVoteType === 1 ? 'active' : '' %>" onclick="window.location.href='/bbs/w_vote?commentNo=<%=commentNo%>&voteType=1&bbsno=<%=column[0]%>'">좋아요 (<%= goodCount %>)</button>
                            <button type="button" class="dislike-button <%= myVoteType === 0 ? 'active' : '' %>" onclick="window.location.href='/bbs/w_vote?commentNo=<%=commentNo%>&voteType=0&bbsno=<%=column[0]%>'">싫어요 (<%= badCount %>)</button>
                        <% } else { %>
                            <span>좋아요 (<%= goodCount %>)</span>
                            <span>싫어요 (<%= badCount %>)</span>
                        <% } %>
                        <button type="button" onclick="toggleReplyForm('<%= commentNo %>')">답글 달기</button>
                        <% if (loggedInUser && loggedInUser === writer) { // 댓글 작성자에게만 댓글 삭제 버튼 표시 %>
                            / <a href='/bbs/w_delete?commentNo=<%=commentNo%>&bbsno=<%=column[0]%>'>댓글 삭제</a>
                        <% } %>
                    </div>
                <% } %>
                
                <div id="replyForm_<%= commentNo %>" class="reply-form">
                    <form name="replyForm_<%= commentNo %>" action="/bbs/wsave" method="post">
                        <textarea name="wbrdmemo" rows="2" cols="60" placeholder="<%= writer %>님에게 답글..."></textarea>
                        <button type="submit">답글 저장</button>
                        <input type="hidden" name="bbsno" value="<%=column[0]%>">
                        <input type="hidden" name="parent_no" value="<%= commentNo %>"> <button type="button" onclick="toggleReplyForm('<%= commentNo %>')">취소</button>
                    </form>
                </div>
            </div>
        <%
            }
        %>
    </div>

    <script>
        // 답글 폼을 토글하는 함수
        function toggleReplyForm(commentNo) {
            var replyForm = document.getElementById('replyForm_' + commentNo);
            
            // 모든 답글 폼을 먼저 닫습니다.
            var openForms = document.querySelectorAll('.reply-form');
            openForms.forEach(form => {
                if (form.id !== 'replyForm_' + commentNo) { // 현재 열려는 폼이 아닌 다른 폼들만
                    form.style.display = 'none';
                }
            });

            // 클릭한 답글 폼을 토글합니다.
            if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                replyForm.style.display = 'block';
            } else {
                replyForm.style.display = 'none';
            }
        }
    </script>
</body>
</html>